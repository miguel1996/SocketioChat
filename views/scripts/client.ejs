<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script>
    var socket;
    jQuery(document).ready(function () {
        //in the beggining the chat is hidden and a login prompt is shown
        $("#chat").css('display', 'none');
        $("#login_form").css('display', 'block');


        socket = io.connect();
        var loginForm = $('#loginForm');
        var form = jQuery('#myForm');
        var txt = jQuery('#txt');
        var chatArea = jQuery('#chatArea');

        //when a new user enters or an existing onde exits
        socket.on('update', function (data) {
            handleNewUser(data);
        });

        //when someone clicks login
        loginForm.submit(function (e) {
            e.preventDefault();
            login();
        });

        //when someone send a message
        form.submit(function (e) {
            e.preventDefault();

            socket.emit('sending message', txt.val());
            txt.val('');

            $([document.documentElement, document.body]).animate({
                scrollTop: $("#send_message_button").offset().top
            }, 1);
        });

        //a new message on the general chat
        socket.on('new message', function (data) {
            writeInChatArea(data.socket, data.message, Date.now());
            //chatArea.append('<div class="well">' + data.socket + ': ' + data.message + '</div>');
        });

        socket.on('private', function (data) {
            chatArea.append('<div class="well">TEST:' + data.socket + ': ' + data.message + '</div>');
        });

        socket.on('auth', function (data) {
            if (data.message === 'sucess') {
                $("#chat").css('display', 'block');
                $("#login_form").css('display', 'none');
                insertLastMessages(data.lastMessages);
            } else {
                alert(data.message);
            }
        });


    });

    //when the user clicks login
    function login() {
        let user_name = $("#user_name").val();
        let password = $("#password").val();
        socket.emit('join', { user_name, password });

    }

    //handles when a new user enters or an existing onde exits
    function handleNewUser(data) {
        var usersArea = jQuery('#users');
        var conns = data.connections;
        usersArea.html('');

        for (var key in conns) {
            usersArea.append('<div class="well">' + conns[key] + '</div>');
        }
        $('#chatArea').append('<div class="well">' + data.message.welcome + '</div>');
    }

    function insertLastMessages(lastMessages) {
        lastMessages.reverse();
        for (let index = 0; index < lastMessages.length; index++) {
            // let date = new Date(lastMessages[index].timestamp);
            // let hour = date.getHours();
            // let minutes = date.getMinutes();
            // let seconds = date.getSeconds();
            // let dateFormatted = hour + ":" + minutes + ":" + seconds;
            // $('#chatArea').append('<div class="well">' + dateFormatted + ' ' + lastMessages[index].user_name + ': ' + lastMessages[index].details + '</div>');
            writeInChatArea(lastMessages[index].user_name,lastMessages[index].details,lastMessages[index].timestamp);
        }
    }

    function writeInChatArea(user, message, tmsp)
    {
        let date = new Date(tmsp);
        let hour = date.getHours()+'h';
        let minutes = date.getMinutes()+'m';
        let seconds = date.getSeconds()+'s';
        let dateFormatted = hour + minutes + seconds;
        $('#chatArea').append('<div class="well">' + dateFormatted + ' ' + user + ': ' + message + '</div>');
    }

</script>